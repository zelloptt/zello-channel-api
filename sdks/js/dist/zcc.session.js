!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Session=t():(e.ZCC=e.ZCC||{},e.ZCC.Session=t())}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=17)}([function(e,t){var n,r,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var c,u=[],l=!1,f=-1;function p(){l&&c&&(l=!1,c.length?u=c.concat(u):f=-1,u.length&&h())}function h(){if(!l){var e=a(p);l=!0;for(var t=u.length;t;){for(c=u,u=[];++f<t;)c&&c[f].run();f=-1,t=u.length}c=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function _(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new d(e,t)),1!==u.length||l||a(h)},d.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=_,i.addListener=_,i.once=_,i.off=_,i.removeListener=_,i.removeAllListeners=_,i.emit=_,i.prependListener=_,i.prependOnceListener=_,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t,n){"use strict";e.exports={ERROR_NOT_ENOUGH_PARAMS:"Not enough parameters",ERROR_INVALID_SERVER_PROTOCOL:"Invalid server protocol, use ws:// or wss://",ERROR_UNSUPPORTED:"Your browser does not support all required APIs.\nRead more here https://github.com/zelloptt/zello-channel-api",ERROR_RECORDING_NO_HTTPS:"Recording will work over https:// loaded pages only",ERROR_WIDGET_ELEMENT_NOT_FOUND:"DOM element for widget is not found",ERROR_INVALID_DECODER:"Invalid incoming message decoder. Should implement ZCC.Decoder interface",ERROR_INVALID_PLAYER:"Invalid incoming message player. Should implement ZCC.Player interface",ERROR_INVALID_RECORDER:"Invalid outgoing message recorder. Should implement ZCC.Recorder interface",ERROR_INVALID_ENCODER:"Invalid outgoing message encoder. Should implement ZCC.Encoder interface",ERROR_SESSION_FAIL_CONNECT:"Failed to connect",ERROR_INVALID_IMAGE_WIDTH_OR_HEIGHT:"Invalid image width or height",ERROR_FAILED_TO_SEND_IMAGE:"Failed to send image",ERROR_IMAGE_NOT_READY_TO_BE_SENT:"Image is not ready to be sent",ERROR_NO_CAMERA_AVAILABLE:"No camera available",ERROR_TYPE_UNKNOWN_SERVER_ERROR:"Unknown server error",ERROR_TYPE_CONFIGURATION:"configuration",EVENT_ERROR:"error",EVENT_CONNECT:"connect",EVENT_CLOSE:"close",EVENT_LOGON:"logon",EVENT_STATUS:"status",EVENT_START_STREAM:"start_stream",EVENT_STOP_STREAM:"stop_stream",EVENT_SESSION_START_CONNECT:"session_start_connect",EVENT_SESSION_CONNECT:"session_connect",EVENT_SESSION_FAIL_CONNECT:"session_fail_connect",EVENT_SESSION_CONNECTION_LOST:"session_connection_lost",EVENT_SESSION_DISCONNECT:"session_disconnect",EVENT_INCOMING_VOICE_WILL_START:"incoming_voice_will_start",EVENT_INCOMING_VOICE_DID_START:"incoming_voice_did_start",EVENT_INCOMING_VOICE_DID_STOP:"incoming_voice_did_stop",EVENT_OUTGOING_VOICE_DID_STOP:"outgoing_voice_did_stop",EVENT_INCOMING_VOICE_DATA:"incoming_voice_data",EVENT_INCOMING_VOICE_DATA_DECODED:"incoming_voice_data_decoded",EVENT_INCOMING_IMAGE_DATA:"incoming_image_data",EVENT_DATA:"data",EVENT_DATA_ENCODED:"data_encoded",EVENT_ENCODER_DONE:"encoder_done",EVENT_RECORDER_READY:"recorder_ready",EVENT_WIDGET_OPEN_BUTTON_CLICK:"widget_open_button_click",EVENT_WIDGET_MUTE:"widget_mute",EVENT_WIDGET_UNMUTE:"widget_unmute",EVENT_WIDGET_SPEAKING_USERNAME_CLICK:"speaking_username_click",EVENT_INCOMING_TEXT_MESSAGE:"incoming_text_message",EVENT_INCOMING_LOCATION:"incoming_location",EVENT_INCOMING_IMAGE:"incoming_image",EVENT_IMAGE_DATA:"image_data",EVENT_THUMBNAIL_DATA:"thumbnail_data",EVENT_IMAGE_PREVIEW_DATA:"image_preview_data",EVENT_THUMBNAIL_PREVIEW_DATA:"thumbnail_preview_data",EVENT_DISPATCH_CALL_STATUS:"dispatch_call_status",MAX_OUTGOING_IMAGE_SCALE_PX:1280,OUTGOING_IMAGE_THUMBNAIL_SCALE_PX:90,SN_STATUS_SUCCESS:"success",SN_STATUS_ONLINE:"online",SN_STATUS_OFFLINE:"offline",MESSAGE_TYPE_AUDIO:1,MESSAGE_TYPE_IMAGE:2,MESSAGE_TYPE_JSON:123,IMAGE_TYPE_FULL:1,IMAGE_TYPE_THUMBNAIL:2,TALK_PRIORITY_VALUE_NORMAL:100,TALK_PRIORITY_VALUE_LOW:10}},function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(r):void 0},o=n(3).EventEmitter2,s=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{wildcard:!0}))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o),r(t,[{key:"emit",value:function(){i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"emit",this).apply(this,arguments);var e=arguments[0];e instanceof Array&&e.length>1||"string"==typeof e&&-1!==e.indexOf(".")||(arguments[0]=(arguments[0]instanceof Array?arguments[0][0]:arguments[0])+".*",i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"emit",this).apply(this,arguments))}}]),t}();e.exports=s},function(e,t,n){(function(r){var i;!function(o){var s=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},a=10;function c(){this._events={},this._conf&&u.call(this,this._conf)}function u(e){e?(this._conf=e,e.delimiter&&(this.delimiter=e.delimiter),this._maxListeners=e.maxListeners!==o?e.maxListeners:a,e.wildcard&&(this.wildcard=e.wildcard),e.newListener&&(this._newListener=e.newListener),e.removeListener&&(this._removeListener=e.removeListener),e.verboseMemoryLeak&&(this.verboseMemoryLeak=e.verboseMemoryLeak),this.wildcard&&(this.listenerTree={})):this._maxListeners=a}function l(e,t){var n="(node) warning: possible EventEmitter memory leak detected. "+e+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(n+=" Event name: "+t+"."),void 0!==r&&r.emitWarning){var i=new Error(n);i.name="MaxListenersExceededWarning",i.emitter=this,i.count=e,r.emitWarning(i)}else console.error(n),console.trace&&console.trace()}function f(e){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,u.call(this,e)}function p(e,t,n,r){if(!n)return[];var i,o,s,a,c,u,l,f=[],h=t.length,d=t[r],_=t[r+1];if(r===h&&n._listeners){if("function"==typeof n._listeners)return e&&e.push(n._listeners),[n];for(i=0,o=n._listeners.length;i<o;i++)e&&e.push(n._listeners[i]);return[n]}if("*"===d||"**"===d||n[d]){if("*"===d){for(s in n)"_listeners"!==s&&n.hasOwnProperty(s)&&(f=f.concat(p(e,t,n[s],r+1)));return f}if("**"===d){for(s in(l=r+1===h||r+2===h&&"*"===_)&&n._listeners&&(f=f.concat(p(e,t,n,h))),n)"_listeners"!==s&&n.hasOwnProperty(s)&&("*"===s||"**"===s?(n[s]._listeners&&!l&&(f=f.concat(p(e,t,n[s],h))),f=f.concat(p(e,t,n[s],r))):f=s===_?f.concat(p(e,t,n[s],r+2)):f.concat(p(e,t,n[s],r)));return f}f=f.concat(p(e,t,n[d],r+1))}if((a=n["*"])&&p(e,t,a,r+1),c=n["**"])if(r<h)for(s in c._listeners&&p(e,t,c,h),c)"_listeners"!==s&&c.hasOwnProperty(s)&&(s===_?p(e,t,c[s],r+2):s===d?p(e,t,c[s],r+1):((u={})[s]=c[s],p(e,t,{"**":u},r+1)));else c._listeners?p(e,t,c,h):c["*"]&&c["*"]._listeners&&p(e,t,c["*"],h);return f}f.EventEmitter2=f,f.prototype.delimiter=".",f.prototype.setMaxListeners=function(e){e!==o&&(this._maxListeners=e,this._conf||(this._conf={}),this._conf.maxListeners=e)},f.prototype.event="",f.prototype.once=function(e,t){return this._once(e,t,!1)},f.prototype.prependOnceListener=function(e,t){return this._once(e,t,!0)},f.prototype._once=function(e,t,n){return this._many(e,1,t,n),this},f.prototype.many=function(e,t,n){return this._many(e,t,n,!1)},f.prototype.prependMany=function(e,t,n){return this._many(e,t,n,!0)},f.prototype._many=function(e,t,n,r){var i=this;if("function"!=typeof n)throw new Error("many only accepts instances of Function");function o(){return 0==--t&&i.off(e,o),n.apply(this,arguments)}return o._origin=n,this._on(e,o,r),i},f.prototype.emit=function(){this._events||c.call(this);var e=arguments[0];if("newListener"===e&&!this._newListener&&!this._events.newListener)return!1;var t,n,r,i,o,s=arguments.length;if(this._all&&this._all.length){if(o=this._all.slice(),s>3)for(t=new Array(s),i=0;i<s;i++)t[i]=arguments[i];for(r=0,n=o.length;r<n;r++)switch(this.event=e,s){case 1:o[r].call(this,e);break;case 2:o[r].call(this,e,arguments[1]);break;case 3:o[r].call(this,e,arguments[1],arguments[2]);break;default:o[r].apply(this,t)}}if(this.wildcard){o=[];var a="string"==typeof e?e.split(this.delimiter):e.slice();p.call(this,o,a,this.listenerTree,0)}else{if("function"==typeof(o=this._events[e])){switch(this.event=e,s){case 1:o.call(this);break;case 2:o.call(this,arguments[1]);break;case 3:o.call(this,arguments[1],arguments[2]);break;default:for(t=new Array(s-1),i=1;i<s;i++)t[i-1]=arguments[i];o.apply(this,t)}return!0}o&&(o=o.slice())}if(o&&o.length){if(s>3)for(t=new Array(s-1),i=1;i<s;i++)t[i-1]=arguments[i];for(r=0,n=o.length;r<n;r++)switch(this.event=e,s){case 1:o[r].call(this);break;case 2:o[r].call(this,arguments[1]);break;case 3:o[r].call(this,arguments[1],arguments[2]);break;default:o[r].apply(this,t)}return!0}if(!this._all&&"error"===e)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},f.prototype.emitAsync=function(){this._events||c.call(this);var e=arguments[0];if("newListener"===e&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);var t,n,r,i,o,s=[],a=arguments.length;if(this._all){if(a>3)for(t=new Array(a),i=1;i<a;i++)t[i]=arguments[i];for(r=0,n=this._all.length;r<n;r++)switch(this.event=e,a){case 1:s.push(this._all[r].call(this,e));break;case 2:s.push(this._all[r].call(this,e,arguments[1]));break;case 3:s.push(this._all[r].call(this,e,arguments[1],arguments[2]));break;default:s.push(this._all[r].apply(this,t))}}if(this.wildcard){o=[];var u="string"==typeof e?e.split(this.delimiter):e.slice();p.call(this,o,u,this.listenerTree,0)}else o=this._events[e];if("function"==typeof o)switch(this.event=e,a){case 1:s.push(o.call(this));break;case 2:s.push(o.call(this,arguments[1]));break;case 3:s.push(o.call(this,arguments[1],arguments[2]));break;default:for(t=new Array(a-1),i=1;i<a;i++)t[i-1]=arguments[i];s.push(o.apply(this,t))}else if(o&&o.length){if(o=o.slice(),a>3)for(t=new Array(a-1),i=1;i<a;i++)t[i-1]=arguments[i];for(r=0,n=o.length;r<n;r++)switch(this.event=e,a){case 1:s.push(o[r].call(this));break;case 2:s.push(o[r].call(this,arguments[1]));break;case 3:s.push(o[r].call(this,arguments[1],arguments[2]));break;default:s.push(o[r].apply(this,t))}}else if(!this._all&&"error"===e)return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(s)},f.prototype.on=function(e,t){return this._on(e,t,!1)},f.prototype.prependListener=function(e,t){return this._on(e,t,!0)},f.prototype.onAny=function(e){return this._onAny(e,!1)},f.prototype.prependAny=function(e){return this._onAny(e,!0)},f.prototype.addListener=f.prototype.on,f.prototype._onAny=function(e,t){if("function"!=typeof e)throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),t?this._all.unshift(e):this._all.push(e),this},f.prototype._on=function(e,t,n){if("function"==typeof e)return this._onAny(e,t),this;if("function"!=typeof t)throw new Error("on only accepts instances of Function");return this._events||c.call(this),this._newListener&&this.emit("newListener",e,t),this.wildcard?(function(e,t){for(var n=0,r=(e="string"==typeof e?e.split(this.delimiter):e.slice()).length;n+1<r;n++)if("**"===e[n]&&"**"===e[n+1])return;for(var i=this.listenerTree,s=e.shift();s!==o;){if(i[s]||(i[s]={}),i=i[s],0===e.length)return i._listeners?("function"==typeof i._listeners&&(i._listeners=[i._listeners]),i._listeners.push(t),!i._listeners.warned&&this._maxListeners>0&&i._listeners.length>this._maxListeners&&(i._listeners.warned=!0,l.call(this,i._listeners.length,s))):i._listeners=t,!0;s=e.shift()}return!0}.call(this,e,t),this):(this._events[e]?("function"==typeof this._events[e]&&(this._events[e]=[this._events[e]]),n?this._events[e].unshift(t):this._events[e].push(t),!this._events[e].warned&&this._maxListeners>0&&this._events[e].length>this._maxListeners&&(this._events[e].warned=!0,l.call(this,this._events[e].length,e))):this._events[e]=t,this)},f.prototype.off=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");var n,r=[];if(this.wildcard){var i="string"==typeof e?e.split(this.delimiter):e.slice();r=p.call(this,null,i,this.listenerTree,0)}else{if(!this._events[e])return this;n=this._events[e],r.push({_listeners:n})}for(var a=0;a<r.length;a++){var c=r[a];if(n=c._listeners,s(n)){for(var u=-1,l=0,f=n.length;l<f;l++)if(n[l]===t||n[l].listener&&n[l].listener===t||n[l]._origin&&n[l]._origin===t){u=l;break}if(u<0)continue;return this.wildcard?c._listeners.splice(u,1):this._events[e].splice(u,1),0===n.length&&(this.wildcard?delete c._listeners:delete this._events[e]),this._removeListener&&this.emit("removeListener",e,t),this}(n===t||n.listener&&n.listener===t||n._origin&&n._origin===t)&&(this.wildcard?delete c._listeners:delete this._events[e],this._removeListener&&this.emit("removeListener",e,t))}return function e(t){if(t!==o){var n=Object.keys(t);for(var r in n){var i=n[r],s=t[i];s instanceof Function||"object"!=typeof s||null===s||(Object.keys(s).length>0&&e(t[i]),0===Object.keys(s).length&&delete t[i])}}}(this.listenerTree),this},f.prototype.offAny=function(e){var t,n=0,r=0;if(e&&this._all&&this._all.length>0){for(n=0,r=(t=this._all).length;n<r;n++)if(e===t[n])return t.splice(n,1),this._removeListener&&this.emit("removeListenerAny",e),this}else{if(t=this._all,this._removeListener)for(n=0,r=t.length;n<r;n++)this.emit("removeListenerAny",t[n]);this._all=[]}return this},f.prototype.removeListener=f.prototype.off,f.prototype.removeAllListeners=function(e){if(e===o)return!this._events||c.call(this),this;if(this.wildcard)for(var t="string"==typeof e?e.split(this.delimiter):e.slice(),n=p.call(this,null,t,this.listenerTree,0),r=0;r<n.length;r++)n[r]._listeners=null;else this._events&&(this._events[e]=null);return this},f.prototype.listeners=function(e){if(this.wildcard){var t=[],n="string"==typeof e?e.split(this.delimiter):e.slice();return p.call(this,t,n,this.listenerTree,0),t}return this._events||c.call(this),this._events[e]||(this._events[e]=[]),s(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},f.prototype.eventNames=function(){return Object.keys(this._events)},f.prototype.listenerCount=function(e){return this.listeners(e).length},f.prototype.listenersAny=function(){return this._all?this._all:[]},(i=function(){return f}.call(t,n,t,e))===o||(e.exports=i)}()}).call(this,n(0))},function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(5),o=n(6),s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"getLoadedLibrary",value:function(){return!!window&&window[i.libraryName]}},{key:"strToCamelCase",value:function(e){return e.split(/[-_]/).map(function(e,t){return 0===t?e.toLowerCase():e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}).join("")}},{key:"getDurationDisplay",value:function(e){var t=Math.floor(e/36e5),n=Math.floor(e/6e4%60),r=Math.floor(e/1e3%60),i=Math.round(e%1e3/100);return i>=10&&(i=9),t>0&&t<10&&(t="0"+t),n>0&&n<10&&(n="0"+n),r>0&&r<10&&(r="0"+r),t?t+":"+n+":"+r+"."+i:n?n+":"+r+"."+i:r?"00:"+r+"."+i:"00:00."+i}},{key:"buildBinaryPacket",value:function(t,n,r,i){var o=new ArrayBuffer(9),s=new DataView(o);return s.setInt8(0,t),s.setInt32(1,n,!1),s.setInt32(5,r,!1),new Uint8Array(e.arrayBufferConcat(o,i))}},{key:"buildCodecHeader",value:function(e,t,n){var r=new ArrayBuffer(4),i=new DataView(r);return i.setUint16(0,e,!0),i.setUint8(2,t),i.setUint8(3,n),btoa(String.fromCharCode.apply(null,new Uint8Array(r)))}},{key:"arrayBufferConcat",value:function(){var e=0,t=null;for(var n in arguments)e+=(t=arguments[n]).byteLength;var r=new Uint8Array(e),i=0;for(var o in arguments)t=arguments[o],r.set(new Uint8Array(t),i),i+=t.byteLength;return r.buffer}},{key:"parseCodedHeader",value:function(e){var t=new DataView(o("data:text/plain;base64,"+e));return{rate:t.getUint16(0,!0),framesPerPacket:t.getUint8(2),frameSize:t.getUint8(3)}}},{key:"isFunction",value:function(t){return e.instanceOf(t,Function)}},{key:"isArray",value:function(t){return e.instanceOf(t,Array)}},{key:"instanceOf",value:function(e,t){return e instanceof t}},{key:"parseIncomingBinaryMessage",value:function(e){var t=new DataView(e.slice(0,9));return{messageType:t.getUint8(0),messageData:new Uint8Array(e.slice(9)),messageId:t.getUint32(1,!1),packetId:t.getUint32(5,!1)}}}]),e}();e.exports=s},function(e,t,n){"use strict";e.exports={libraryName:"ZCC"}},function(e,t,n){"use strict";var r=n(7),i=n(8);function o(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t.buffer}e.exports=function(e){if("string"!=typeof e)throw Error("Argument should be a string");return/^data\:/i.test(e)?function(e){var t=(e=e.replace(/\r?\n/g,"")).indexOf(",");if(-1===t||t<=4)throw new TypeError("malformed data-URI");for(var n=e.substring(5,t).split(";"),i=!1,s="US-ASCII",a=0;a<n.length;a++)"base64"==n[a]?i=!0:0==n[a].indexOf("charset=")&&(s=n[a].substring(8));var c=unescape(e.substring(t+1));i&&(c=r(c));var u=o(c);return u.type=n[0]||"text/plain",u.charset=s,u}(e):(i(e)&&(e=r(e)),o(e))}},function(e,t){e.exports=function(e){return atob(e)}},function(e,t,n){!function(n){"use strict";function r(e,t){if(e instanceof Boolean||"boolean"==typeof e)return!1;if(t instanceof Object||(t={}),t.hasOwnProperty("allowBlank")&&!t.allowBlank&&""===e)return!1;var n="(?:[A-Za-z0-9+\\/]{4})*(?:[A-Za-z0-9+\\/]{2}==|[A-Za-z0-9+/]{3}=)?";return t.mime&&(n="(data:\\w+\\/[a-zA-Z\\+\\-\\.]+;base64,)?"+n),!1===t.paddingRequired&&(n="(?:[A-Za-z0-9+\\/]{4})*(?:[A-Za-z0-9+\\/]{2}(==)?|[A-Za-z0-9+\\/]{3}=?)?"),new RegExp("^"+n+"$","gi").test(e)}void 0!==e&&e.exports&&(t=e.exports=r),t.isBase64=r}()},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){(function(t,n){!function(t){"use strict";"function"==typeof bootstrap?bootstrap("promise",t):e.exports=t()}(function(){"use strict";var e=!1;try{throw new Error}catch(t){e=!!t.stack}var r,i=N(),o=function(){},s=function(){var e={task:void 0,next:null},r=e,i=!1,o=void 0,a=!1,c=[];function u(){for(var t,n;e.next;)t=(e=e.next).task,e.task=void 0,(n=e.domain)&&(e.domain=void 0,n.enter()),l(t,n);for(;c.length;)l(t=c.pop());i=!1}function l(e,t){try{e()}catch(e){if(a)throw t&&t.exit(),setTimeout(u,0),t&&t.enter(),e;setTimeout(function(){throw e},0)}t&&t.exit()}if(s=function(e){r=r.next={task:e,domain:a&&t.domain,next:null},i||(i=!0,o())},"object"==typeof t&&"[object process]"===t.toString()&&t.nextTick)a=!0,o=function(){t.nextTick(u)};else if("function"==typeof n)o="undefined"!=typeof window?n.bind(window,u):function(){n(u)};else if("undefined"!=typeof MessageChannel){var f=new MessageChannel;f.port1.onmessage=function(){o=p,f.port1.onmessage=u,u()};var p=function(){f.port2.postMessage(0)};o=function(){setTimeout(u,0),p()}}else o=function(){setTimeout(u,0)};return s.runAfter=function(e){c.push(e),i||(i=!0,o())},s}(),a=Function.call;function c(e){return function(){return a.apply(e,arguments)}}var u,l=c(Array.prototype.slice),f=c(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(1===arguments.length)for(;;){if(n in this){t=this[n++];break}if(++n>=r)throw new TypeError}for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),p=c(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),h=c(Array.prototype.map||function(e,t){var n=this,r=[];return f(n,function(i,o,s){r.push(e.call(t,o,s,n))},void 0),r}),d=Object.create||function(e){function t(){}return t.prototype=e,new t},_=Object.defineProperty||function(e,t,n){return e[t]=n.value,e},y=c(Object.prototype.hasOwnProperty),v=Object.keys||function(e){var t=[];for(var n in e)y(e,n)&&t.push(n);return t},m=c(Object.prototype.toString);u="undefined"!=typeof ReturnValue?ReturnValue:function(e){this.value=e};var E="From previous event:";function g(t,n){if(e&&n.stack&&"object"==typeof t&&null!==t&&t.stack){for(var r=[],i=n;i;i=i.source)i.stack&&(!t.__minimumStackCounter__||t.__minimumStackCounter__>i.stackCounter)&&(_(t,"__minimumStackCounter__",{value:i.stackCounter,configurable:!0}),r.unshift(i.stack));r.unshift(t.stack);var o=function(e){for(var t=e.split("\n"),n=[],r=0;r<t.length;++r){var i=t[r];w(i)||T(i)||!i||n.push(i)}return n.join("\n")}(r.join("\n"+E+"\n"));_(t,"stack",{value:o,configurable:!0})}}function T(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function O(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(t)return[t[1],Number(t[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(n)return[n[1],Number(n[2])];var r=/.*@(.+):(\d+)$/.exec(e);return r?[r[1],Number(r[2])]:void 0}function w(e){var t=O(e);if(!t)return!1;var n=t[0],o=t[1];return n===r&&o>=i&&o<=q}function N(){if(e)try{throw new Error}catch(e){var t=e.stack.split("\n"),n=O(t[0].indexOf("@")>0?t[1]:t[2]);if(!n)return;return r=n[0],n[1]}}function I(e){return e instanceof S?e:M(e)?function(e){var t=k();return I.nextTick(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(e){t.reject(e)}}),t.promise}(e):F(e)}I.resolve=I,I.nextTick=s,I.longStackSupport=!1;var b=1;function k(){var t,n=[],r=[],i=d(k.prototype),o=d(S.prototype);if(o.promiseDispatch=function(e,i,o){var s=l(arguments);n?(n.push(s),"when"===i&&o[1]&&r.push(o[1])):I.nextTick(function(){t.promiseDispatch.apply(t,s)})},o.valueOf=function(){if(n)return o;var e=L(t);return j(e)&&(t=e),e},o.inspect=function(){return t?t.inspect():{state:"pending"}},I.longStackSupport&&e)try{throw new Error}catch(e){o.stack=e.stack.substring(e.stack.indexOf("\n")+1),o.stackCounter=b++}function s(i){t=i,I.longStackSupport&&e&&(o.source=i),f(n,function(e,t){I.nextTick(function(){i.promiseDispatch.apply(i,t)})},void 0),n=void 0,r=void 0}return i.promise=o,i.resolve=function(e){t||s(I(e))},i.fulfill=function(e){t||s(F(e))},i.reject=function(e){t||s(G(e))},i.notify=function(e){t||f(r,function(t,n){I.nextTick(function(){n(e)})},void 0)},i}function A(e){if("function"!=typeof e)throw new TypeError("resolver must be a function.");var t=k();try{e(t.resolve,t.reject,t.notify)}catch(e){t.reject(e)}return t.promise}function C(e){return A(function(t,n){for(var r=0,i=e.length;r<i;r++)I(e[r]).then(t,n)})}function S(e,t,n){void 0===t&&(t=function(e){return G(new Error("Promise does not support operation: "+e))}),void 0===n&&(n=function(){return{state:"unknown"}});var r=d(S.prototype);if(r.promiseDispatch=function(n,i,o){var s;try{s=e[i]?e[i].apply(r,o):t.call(r,i,o)}catch(e){s=G(e)}n&&n(s)},r.inspect=n,n){var i=n();"rejected"===i.state&&(r.exception=i.reason),r.valueOf=function(){var e=n();return"pending"===e.state||"rejected"===e.state?r:e.value}}return r}function R(e,t,n,r){return I(e).then(t,n,r)}function L(e){if(j(e)){var t=e.inspect();if("fulfilled"===t.state)return t.value}return e}function j(e){return e instanceof S}function M(e){return function(e){return e===Object(e)}(e)&&"function"==typeof e.then}"object"==typeof t&&t&&t.env&&t.env.Q_DEBUG&&(I.longStackSupport=!0),I.defer=k,k.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(l(arguments,1)):e.resolve(n)}},I.Promise=A,I.promise=A,A.race=C,A.all=H,A.reject=G,A.resolve=I,I.passByCopy=function(e){return e},S.prototype.passByCopy=function(){return this},I.join=function(e,t){return I(e).join(t)},S.prototype.join=function(e){return I([this,e]).spread(function(e,t){if(e===t)return e;throw new Error("Q can't join: not the same: "+e+" "+t)})},I.race=C,S.prototype.race=function(){return this.then(I.race)},I.makePromise=S,S.prototype.toString=function(){return"[object Promise]"},S.prototype.then=function(e,t,n){var r=this,i=k(),o=!1;return I.nextTick(function(){r.promiseDispatch(function(t){o||(o=!0,i.resolve(function(t){try{return"function"==typeof e?e(t):t}catch(e){return G(e)}}(t)))},"when",[function(e){o||(o=!0,i.resolve(function(e){if("function"==typeof t){g(e,r);try{return t(e)}catch(e){return G(e)}}return G(e)}(e)))}])}),r.promiseDispatch(void 0,"when",[void 0,function(e){var t,r=!1;try{t=function(e){return"function"==typeof n?n(e):e}(e)}catch(e){if(r=!0,!I.onerror)throw e;I.onerror(e)}r||i.notify(t)}]),i.promise},I.tap=function(e,t){return I(e).tap(t)},S.prototype.tap=function(e){return e=I(e),this.then(function(t){return e.fcall(t).thenResolve(t)})},I.when=R,S.prototype.thenResolve=function(e){return this.then(function(){return e})},I.thenResolve=function(e,t){return I(e).thenResolve(t)},S.prototype.thenReject=function(e){return this.then(function(){throw e})},I.thenReject=function(e,t){return I(e).thenReject(t)},I.nearer=L,I.isPromise=j,I.isPromiseAlike=M,I.isPending=function(e){return j(e)&&"pending"===e.inspect().state},S.prototype.isPending=function(){return"pending"===this.inspect().state},I.isFulfilled=function(e){return!j(e)||"fulfilled"===e.inspect().state},S.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},I.isRejected=function(e){return j(e)&&"rejected"===e.inspect().state},S.prototype.isRejected=function(){return"rejected"===this.inspect().state};var D=[],x=[],V=[],P=!0;function U(){D.length=0,x.length=0,P||(P=!0)}function G(e){var n=S({when:function(n){return n&&function(e){if(P){var n=p(x,e);-1!==n&&("object"==typeof t&&"function"==typeof t.emit&&I.nextTick.runAfter(function(){var r=p(V,e);-1!==r&&(t.emit("rejectionHandled",D[n],e),V.splice(r,1))}),x.splice(n,1),D.splice(n,1))}}(this),n?n(e):this}},function(){return this},function(){return{state:"rejected",reason:e}});return function(e,n){P&&("object"==typeof t&&"function"==typeof t.emit&&I.nextTick.runAfter(function(){-1!==p(x,e)&&(t.emit("unhandledRejection",n,e),V.push(e))}),x.push(e),n&&void 0!==n.stack?D.push(n.stack):D.push("(no stack) "+n))}(n,e),n}function F(e){return S({when:function(){return e},get:function(t){return e[t]},set:function(t,n){e[t]=n},delete:function(t){delete e[t]},post:function(t,n){return null===t||void 0===t?e.apply(void 0,n):e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},keys:function(){return v(e)}},void 0,function(){return{state:"fulfilled",value:e}})}function B(e,t,n){return I(e).spread(t,n)}function W(e,t,n){return I(e).dispatch(t,n)}function H(e){return R(e,function(e){var t=0,n=k();return f(e,function(r,i,o){var s;j(i)&&"fulfilled"===(s=i.inspect()).state?e[o]=s.value:(++t,R(i,function(r){e[o]=r,0==--t&&n.resolve(e)},n.reject,function(e){n.notify({index:o,value:e})}))},void 0),0===t&&n.resolve(e),n.promise})}function Y(e){if(0===e.length)return I.resolve();var t=I.defer(),n=0;return f(e,function(r,i,o){var s=e[o];n++,R(s,function(e){t.resolve(e)},function(e){if(0==--n){var r=e||new Error(""+e);r.message="Q can't get fulfillment value from any promise, all promises were rejected. Last error message: "+r.message,t.reject(r)}},function(e){t.notify({index:o,value:e})})},void 0),t.promise}function Z(e){return R(e,function(e){return e=h(e,I),R(H(h(e,function(e){return R(e,o,o)})),function(){return e})})}I.resetUnhandledRejections=U,I.getUnhandledReasons=function(){return D.slice()},I.stopUnhandledRejectionTracking=function(){U(),P=!1},U(),I.reject=G,I.fulfill=F,I.master=function(e){return S({isDef:function(){}},function(t,n){return W(e,t,n)},function(){return I(e).inspect()})},I.spread=B,S.prototype.spread=function(e,t){return this.all().then(function(t){return e.apply(void 0,t)},t)},I.async=function(e){return function(){function t(e,t){var o;if("undefined"==typeof StopIteration){try{o=n[e](t)}catch(e){return G(e)}return o.done?I(o.value):R(o.value,r,i)}try{o=n[e](t)}catch(e){return function(e){return"[object StopIteration]"===m(e)||e instanceof u}(e)?I(e.value):G(e)}return R(o,r,i)}var n=e.apply(this,arguments),r=t.bind(t,"next"),i=t.bind(t,"throw");return r()}},I.spawn=function(e){I.done(I.async(e)())},I.return=function(e){throw new u(e)},I.promised=function(e){return function(){return B([this,H(arguments)],function(t,n){return e.apply(t,n)})}},I.dispatch=W,S.prototype.dispatch=function(e,t){var n=this,r=k();return I.nextTick(function(){n.promiseDispatch(r.resolve,e,t)}),r.promise},I.get=function(e,t){return I(e).dispatch("get",[t])},S.prototype.get=function(e){return this.dispatch("get",[e])},I.set=function(e,t,n){return I(e).dispatch("set",[t,n])},S.prototype.set=function(e,t){return this.dispatch("set",[e,t])},I.del=I.delete=function(e,t){return I(e).dispatch("delete",[t])},S.prototype.del=S.prototype.delete=function(e){return this.dispatch("delete",[e])},I.mapply=I.post=function(e,t,n){return I(e).dispatch("post",[t,n])},S.prototype.mapply=S.prototype.post=function(e,t){return this.dispatch("post",[e,t])},I.send=I.mcall=I.invoke=function(e,t){return I(e).dispatch("post",[t,l(arguments,2)])},S.prototype.send=S.prototype.mcall=S.prototype.invoke=function(e){return this.dispatch("post",[e,l(arguments,1)])},I.fapply=function(e,t){return I(e).dispatch("apply",[void 0,t])},S.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])},I.try=I.fcall=function(e){return I(e).dispatch("apply",[void 0,l(arguments,1)])},S.prototype.fcall=function(){return this.dispatch("apply",[void 0,l(arguments)])},I.fbind=function(e){var t=I(e),n=l(arguments,1);return function(){return t.dispatch("apply",[this,n.concat(l(arguments))])}},S.prototype.fbind=function(){var e=this,t=l(arguments);return function(){return e.dispatch("apply",[this,t.concat(l(arguments))])}},I.keys=function(e){return I(e).dispatch("keys",[])},S.prototype.keys=function(){return this.dispatch("keys",[])},I.all=H,S.prototype.all=function(){return H(this)},I.any=Y,S.prototype.any=function(){return Y(this)},I.allResolved=function(e,t,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("allResolved is deprecated, use allSettled instead.",new Error("").stack),e.apply(e,arguments)}}(Z),S.prototype.allResolved=function(){return Z(this)},I.allSettled=function(e){return I(e).allSettled()},S.prototype.allSettled=function(){return this.then(function(e){return H(h(e,function(e){function t(){return e.inspect()}return(e=I(e)).then(t,t)}))})},I.fail=I.catch=function(e,t){return I(e).then(void 0,t)},S.prototype.fail=S.prototype.catch=function(e){return this.then(void 0,e)},I.progress=function(e,t){return I(e).then(void 0,void 0,t)},S.prototype.progress=function(e){return this.then(void 0,void 0,e)},I.fin=I.finally=function(e,t){return I(e).finally(t)},S.prototype.fin=S.prototype.finally=function(e){if(!e||"function"!=typeof e.apply)throw new Error("Q can't apply finally callback");return e=I(e),this.then(function(t){return e.fcall().then(function(){return t})},function(t){return e.fcall().then(function(){throw t})})},I.done=function(e,t,n,r){return I(e).done(t,n,r)},S.prototype.done=function(e,n,r){var i=function(e){I.nextTick(function(){if(g(e,o),!I.onerror)throw e;I.onerror(e)})},o=e||n||r?this.then(e,n,r):this;"object"==typeof t&&t&&t.domain&&(i=t.domain.bind(i)),o.then(void 0,i)},I.timeout=function(e,t,n){return I(e).timeout(t,n)},S.prototype.timeout=function(e,t){var n=k(),r=setTimeout(function(){t&&"string"!=typeof t||((t=new Error(t||"Timed out after "+e+" ms")).code="ETIMEDOUT"),n.reject(t)},e);return this.then(function(e){clearTimeout(r),n.resolve(e)},function(e){clearTimeout(r),n.reject(e)},n.notify),n.promise},I.delay=function(e,t){return void 0===t&&(t=e,e=void 0),I(e).delay(t)},S.prototype.delay=function(e){return this.then(function(t){var n=k();return setTimeout(function(){n.resolve(t)},e),n.promise})},I.nfapply=function(e,t){return I(e).nfapply(t)},S.prototype.nfapply=function(e){var t=k(),n=l(e);return n.push(t.makeNodeResolver()),this.fapply(n).fail(t.reject),t.promise},I.nfcall=function(e){var t=l(arguments,1);return I(e).nfapply(t)},S.prototype.nfcall=function(){var e=l(arguments),t=k();return e.push(t.makeNodeResolver()),this.fapply(e).fail(t.reject),t.promise},I.nfbind=I.denodeify=function(e){if(void 0===e)throw new Error("Q can't wrap an undefined function");var t=l(arguments,1);return function(){var n=t.concat(l(arguments)),r=k();return n.push(r.makeNodeResolver()),I(e).fapply(n).fail(r.reject),r.promise}},S.prototype.nfbind=S.prototype.denodeify=function(){var e=l(arguments);return e.unshift(this),I.denodeify.apply(void 0,e)},I.nbind=function(e,t){var n=l(arguments,2);return function(){var r=n.concat(l(arguments)),i=k();return r.push(i.makeNodeResolver()),I(function(){return e.apply(t,arguments)}).fapply(r).fail(i.reject),i.promise}},S.prototype.nbind=function(){var e=l(arguments,0);return e.unshift(this),I.nbind.apply(void 0,e)},I.nmapply=I.npost=function(e,t,n){return I(e).npost(t,n)},S.prototype.nmapply=S.prototype.npost=function(e,t){var n=l(t||[]),r=k();return n.push(r.makeNodeResolver()),this.dispatch("post",[e,n]).fail(r.reject),r.promise},I.nsend=I.nmcall=I.ninvoke=function(e,t){var n=l(arguments,2),r=k();return n.push(r.makeNodeResolver()),I(e).dispatch("post",[t,n]).fail(r.reject),r.promise},S.prototype.nsend=S.prototype.nmcall=S.prototype.ninvoke=function(e){var t=l(arguments,1),n=k();return t.push(n.makeNodeResolver()),this.dispatch("post",[e,t]).fail(n.reject),n.promise},I.nodeify=function(e,t){return I(e).nodeify(t)},S.prototype.nodeify=function(e){if(!e)return this;this.then(function(t){I.nextTick(function(){e(null,t)})},function(t){I.nextTick(function(){e(t)})})},I.noConflict=function(){throw new Error("Q.noConflict only works when Q is used as a global")};var q=N();return I})}).call(this,n(0),n(11).setImmediate)},function(e,t,n){(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,i=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(i.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new o(i.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(12),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(9))},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var r,i=1,o={},s=!1,a=e.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(e);c=c&&c.setTimeout?c:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick(function(){l(e)})}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?function(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&l(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),r=function(n){e.postMessage(t+n,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){l(e.data)},r=function(t){e.port2.postMessage(t)}}():a&&"onreadystatechange"in a.createElement("script")?function(){var e=a.documentElement;r=function(t){var n=a.createElement("script");n.onreadystatechange=function(){l(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}():r=function(e){setTimeout(l,0,e)},c.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var s={callback:e,args:t};return o[i]=s,r(i),i++},c.clearImmediate=u}function u(e){delete o[e]}function l(e){if(s)setTimeout(l,0,e);else{var t=o[e];if(t){s=!0;try{!function(e){var t=e.callback,r=e.args;switch(r.length){case 0:t();break;case 1:t(r[0]);break;case 2:t(r[0],r[1]);break;case 3:t(r[0],r[1],r[2]);break;default:t.apply(n,r)}}(t)}finally{u(e),s=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(9),n(0))},,,,,function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(2),o=n(10),s=n(1),a=n(4),c=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),r=a.getLoadedLibrary();return t.validateInitialOptions(e),n.options=Object.assign({},r.Sdk.initOptions,{maxConnectAttempts:5,connectRetryTimeoutMs:1e3,autoSendAudio:!0,noPersistentPlayer:!1},e),n.callbacks={},n.wsConnection=null,n.refreshToken=null,n.seq=0,n.maxConnectAttempts=n.options.maxConnectAttempts,n.connectAttempts=n.maxConnectAttempts,n.connectRetryTimeoutMs=n.options.connectRetryTimeoutMs,n.selfDisconnect=!1,n.incomingMessages={},n.activeOutgoingMessage=null,n.activeOutgoingImage=null,n.wasOnline=!1,n.reconnectTimeout=null,n.channelConfigurationError=!1,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i),r(t,[{key:"getSeq",value:function(){return++this.seq}},{key:"connect",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this.connectOrReconnect(e)}},{key:"clearExistingReconnectTimeout",value:function(){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout)}},{key:"connectOrReconnect",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=o.defer();return this.connectAttempts?(this.connectAttempts===this.maxConnectAttempts&&this.emit(s.EVENT_SESSION_START_CONNECT),this.connectAttempts--,this.doConnect().then(function(){return e.doLogon()}).then(function(n){"function"==typeof t&&t.apply(e,[null,n]),e.emit(s.EVENT_SESSION_CONNECT),r.resolve(n)}).catch(function(r){if(e.connectAttempts)return e.clearExistingReconnectTimeout(),void(e.reconnectTimeout=setTimeout(function(){e.connectOrReconnect(t,n)},e.connectRetryTimeoutMs));"function"==typeof t&&t.apply(e,[r]),e.emit(n?s.EVENT_SESSION_DISCONNECT:s.EVENT_SESSION_FAIL_CONNECT,r)}),r.promise):(this.emit(this.channelConfigurationError?s.EVENT_SESSION_DISCONNECT:s.EVENT_SESSION_FAIL_CONNECT),r.reject("Failed to connect"))}},{key:"doConnect",value:function(){var e=this,t=o.defer();return this.wsConnection=new WebSocket(this.options.serverUrl),this.wsConnection.binaryType="arraybuffer",this.wsConnection.addEventListener("open",function(){return t.resolve()}),this.wsConnection.addEventListener("message",function(t){e.wsMessageHandler(t.data)}),this.wsConnection.addEventListener("error",function(e){return t.reject(e)}),this.wsConnection.addEventListener("close",function(n){e.selfDisconnect?e.selfDisconnect=!1:"fulfilled"===t.promise.inspect().state&&(e.emit(s.EVENT_SESSION_CONNECTION_LOST,n.reason),e.clearExistingReconnectTimeout(),e.reconnectTimeout=setTimeout(function(){e.connectOrReconnect(null,!0)},e.connectRetryTimeoutMs))}),t.promise}},{key:"doLogon",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=o.defer(),n={command:"logon",seq:this.getSeq(),channel:this.options.channel};return e?n.refresh_token=e:n.auth_token=this.options.authToken,this.options.listenOnly&&(n.listen_only=!0),this.options.username&&(n.username=this.options.username,n.password=this.options.password),this.sendCommand(n,function(e,n){e?t.reject(e):t.resolve(n)}),t.promise}},{key:"disconnect",value:function(){this.selfDisconnect=!0,this.wsConnection.close()}},{key:"wsBinaryDataHandler",value:function(e){var t=a.parseIncomingBinaryMessage(e);switch(t.messageType){case s.MESSAGE_TYPE_AUDIO:this.emit(s.EVENT_INCOMING_VOICE_DATA,t);break;case s.MESSAGE_TYPE_IMAGE:this.emit(s.EVENT_INCOMING_IMAGE_DATA,t)}}},{key:"jsonDataHandler",value:function(e){e&&e.seq&&this.handleCallbacks(e),e.refresh_token&&(this.refreshToken=e.refresh_token);var t=a.getLoadedLibrary();switch(e.command){case"on_error":var n=s.ERROR_TYPE_UNKNOWN_SERVER_ERROR;e.error&&(n=e.error),this.emit(s.EVENT_ERROR,n);break;case"on_channel_status":if(!this.wasOnline)switch(e.status){case s.SN_STATUS_ONLINE:this.wasOnline=!0,this.connectAttempts=this.maxConnectAttempts;break;case s.SN_STATUS_OFFLINE:e.error&&e.error_type===s.ERROR_TYPE_CONFIGURATION&&(this.channelConfigurationError=!0)}this.emit(s.EVENT_STATUS,e);break;case"on_stream_start":var r=new t.IncomingMessage(e,this);this.incomingMessages[e.stream_id]=r,this.emit(s.EVENT_INCOMING_VOICE_WILL_START,r);break;case"on_stream_stop":if(!this.incomingMessages[e.stream_id]){this.emit(s.EVENT_OUTGOING_VOICE_DID_STOP,e.stream_id);break}this.emit(s.EVENT_INCOMING_VOICE_DID_STOP,this.incomingMessages[e.stream_id]);break;case"on_text_message":this.emit(s.EVENT_INCOMING_TEXT_MESSAGE,e);break;case"on_location":this.emit(s.EVENT_INCOMING_LOCATION,e);break;case"on_image":var i=new t.IncomingImage(e,this);this.emit(s.EVENT_INCOMING_IMAGE,i);break;case"on_dispatch_call_status":this.emit(s.EVENT_DISPATCH_CALL_STATUS,e)}}},{key:"wsMessageHandler",value:function(e){var t=null;try{t=JSON.parse(e)}catch(e){}return t?this.jsonDataHandler(t):this.wsBinaryDataHandler(e)}},{key:"handleCallbacks",value:function(e){var t=e.error?e.error:null,n=this.callbacks[e.seq];"function"==typeof n&&(n.apply(this,[t,e]),delete this.callbacks[e.seq])}},{key:"sendCommand",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e.seq&&t&&(this.callbacks[e.seq]=t),this.wsConnection.send(JSON.stringify(e))}},{key:"sendBinary",value:function(e){this.wsConnection.send(e)}},{key:"startStream",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.sendCommandWithCallback("start_stream",e,t)}},{key:"stopStream",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.sendCommandWithCallback("stop_stream",e,t)}},{key:"startVoiceMessage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=a.getLoadedLibrary();return this.activeOutgoingMessage=new r.OutgoingMessage(this,t,n),this.activeOutgoingMessage.on(s.EVENT_DATA_ENCODED,function(t){e.activeOutgoingMessage.options.autoSendAudio&&e.sendBinary(t)}),this.activeOutgoingMessage}},{key:"onIncomingVoiceDidStart",value:function(e){this.emit(s.EVENT_INCOMING_VOICE_DID_START,e)}},{key:"onIncomingVoiceDecoded",value:function(e,t){this.emit(s.EVENT_INCOMING_VOICE_DATA_DECODED,e,t)}},{key:"sendImage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=a.getLoadedLibrary();return this.activeOutgoingImage=new t.OutgoingImage(this,e),this.activeOutgoingImage}},{key:"sendTextMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.sendCommandWithCallback("send_text_message",e,t)}},{key:"sendLocation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.sendCommandWithCallback("send_location",e,t)}},{key:"endDispatchCall",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n={call_id:e,channel:this.options.channel};return this.sendCommandWithCallback("end_dispatch_call",n,t)}},{key:"sendCommandWithCallback",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t.seq=this.getSeq(),t.command=e;var i=o.defer();return this.sendCommand(t,function(e,t){if(e)return"function"==typeof r&&r.apply(n,[e]),void i.reject(e);"function"==typeof r&&r.apply(n,[null,t]),i.resolve(t)}),i.promise}}],[{key:"validateInitialOptions",value:function(e){if(!e||!e.serverUrl||!e.channel||e.username&&!e.password||!e.authToken&&!e.username)throw new Error(s.ERROR_NOT_ENOUGH_PARAMS);if(!e.serverUrl.match(/^wss?:\/\//i))throw new Error(s.ERROR_INVALID_SERVER_PROTOCOL)}}]),t}();e.exports=c}])});